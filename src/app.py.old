import streamlit as st
from streamlit_autorefresh import st_autorefresh
from datetime import datetime, timedelta, timezone

# Import config
try:
    from config import REGIONS, DATABASE_NAME, TIMEZONE, UTC_OFFSET_HOURS
except ImportError:
    REGIONS = st.secrets["regions"]["list"]
    DATABASE_NAME = st.secrets["database"]["name"]
    TIMEZONE = st.secrets["timezone"]["name"]
    UTC_OFFSET_HOURS = st.secrets["timezone"]["utc_offset_hours"]

# Page config
st.set_page_config(
    page_title="Malaysia Transit Tracker",
    page_icon="ğŸš‡",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Initialize session state
if 'theme_mode' not in st.session_state:
    st.session_state.theme_mode = 'light'
if 'map_theme' not in st.session_state:
    st.session_state.map_theme = 'light'
if 'auto_refresh' not in st.session_state:
    st.session_state.auto_refresh = False
if 'last_refresh' not in st.session_state:
    st.session_state.last_refresh = None

# Sidebar controls
with st.sidebar:
    st.title("âš™ï¸ Settings")
    
    # Theme controls
    st.subheader("ğŸ¨ Appearance")
    theme_col1, theme_col2 = st.columns(2)
    with theme_col1:
        if st.button("â˜€ï¸ Light" if st.session_state.theme_mode == 'dark' else "ğŸŒ™ Dark", 
                    use_container_width=True):
            st.session_state.theme_mode = 'dark' if st.session_state.theme_mode == 'light' else 'light'
            st.rerun()
    
    with theme_col2:
        if st.button("ğŸ—ºï¸ Map: L" if st.session_state.map_theme == 'light' else "ğŸ—ºï¸ Map: D",
                    use_container_width=True):
            st.session_state.map_theme = 'dark' if st.session_state.map_theme == 'light' else 'light'
            st.rerun()
    
    st.divider()
    
    # Refresh controls
    st.subheader("ğŸ”„ Refresh Mode")
    refresh_mode = st.radio(
        "Mode",
        ["Manual", "Auto (10s)"],
        index=1 if st.session_state.auto_refresh else 0,
        horizontal=True
    )
    st.session_state.auto_refresh = (refresh_mode == "Auto (10s)")
    
    st.divider()
    
    # Page navigation
    st.subheader("ğŸ“ Navigation")
    page = st.radio(
        "Select View",
        ["ğŸ—ºï¸ Live Map", "ğŸ“Š Data Table", "ğŸ“ˆ Analytics"],
        label_visibility="collapsed"
    )

# Auto refresh
if st.session_state.auto_refresh:
    st_autorefresh(interval=10000, key="auto_refresh_counter")

# Apply custom CSS for dark mode
if st.session_state.theme_mode == 'dark':
    st.markdown("""
        <style>
        .stApp {
            background-color: #0e1117;
            color: #fafafa;
        }
        </style>
    """, unsafe_allow_html=True)

# Current time
now_utc = datetime.now(timezone.utc)
now_kl = now_utc + timedelta(hours=UTC_OFFSET_HOURS)
current_time = now_kl.strftime('%d %b %Y %H:%M:%S')

# Header
st.markdown(f"### ğŸš‡ Malaysia Real-Time Transit Tracker")
st.caption(f"ğŸ“… {current_time} (GMT+8)")

# Route to pages
if page == "ğŸ—ºï¸ Live Map":
    from pages import live_map
    live_map.show()
elif page == "ğŸ“Š Data Table":
    from pages import data_table
    data_table.show()
else:
    from pages import analytics
    analytics.show()
