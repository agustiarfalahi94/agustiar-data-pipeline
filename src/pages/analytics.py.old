import streamlit as st
import plotly.express as px
import plotly.graph_objects as go
from utils import db, data_processor
from ingestion_rapidbus_mrtfeeder import fetch_rapid_rail_live

def show():
    # Manual refresh button
    if not st.session_state.auto_refresh:
        if st.button("ðŸ”„ Refresh Data", type="primary"):
            with st.spinner('ðŸ›°ï¸ Fetching...'):
                fetch_rapid_rail_live()
                st.session_state.last_refresh = True
            st.rerun()
    
    # Get data
    df_live, metrics, actual_sync_time = db.get_live_data_optimized()
    
    if df_live is None or df_live.empty:
        st.info("ðŸ›°ï¸ No data available. Please refresh.")
        return
    
    # Show sync time
    if actual_sync_time:
        st.success(f"Data updated: {actual_sync_time}")
    
    # Overview metrics
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("Total Buses", metrics['total'])
    col2.metric("Active Regions", metrics['regions'])
    col3.metric("Avg Speed", f"{df_live['speed'].mean():.2f} m/s")
    col4.metric("Busiest", metrics['busiest'])
    
    st.divider()
    
    # Charts
    col_chart1, col_chart2 = st.columns(2)
    
    with col_chart1:
        st.subheader("ðŸ“Š Buses by Region")
        region_counts = df_live['region'].value_counts().reset_index()
        region_counts.columns = ['Region', 'Count']
        
        fig1 = px.bar(
            region_counts,
            x='Count',
            y='Region',
            orientation='h',
            color='Count',
            color_continuous_scale='Blues'
        )
        fig1.update_layout(
            height=400,
            showlegend=False,
            template='plotly_dark' if st.session_state.theme_mode == 'dark' else 'plotly_white'
        )
        st.plotly_chart(fig1, use_container_width=True)
    
    with col_chart2:
        st.subheader("ðŸƒ Speed Distribution")
        # Filter out zero speeds for cleaner visualization
        speed_data = df_live[df_live['speed'] > 0]
        
        fig2 = px.histogram(
            speed_data,
            x='speed',
            nbins=30,
            labels={'speed': 'Speed (m/s)', 'count': 'Frequency'}
        )
        fig2.update_layout(
            height=400,
            showlegend=False,
            template='plotly_dark' if st.session_state.theme_mode == 'dark' else 'plotly_white'
        )
        st.plotly_chart(fig2, use_container_width=True)
    
    # Pie chart for distribution
    st.subheader("ðŸŽ¯ Regional Distribution")
    
    fig3 = px.pie(
        region_counts,
        values='Count',
        names='Region',
        hole=0.4
    )
    fig3.update_layout(
        height=500,
        template='plotly_dark' if st.session_state.theme_mode == 'dark' else 'plotly_white'
    )
    st.plotly_chart(fig3, use_container_width=True)
    
    # Speed by region box plot
    st.subheader("ðŸ“ˆ Speed Analysis by Region")
    
    fig4 = px.box(
        df_live[df_live['speed'] > 0],
        x='region',
        y='speed',
        labels={'region': 'Region', 'speed': 'Speed (m/s)'}
    )
    fig4.update_layout(
        height=500,
        xaxis_tickangle=-45,
        template='plotly_dark' if st.session_state.theme_mode == 'dark' else 'plotly_white'
    )
    st.plotly_chart(fig4, use_container_width=True)
    
    # Summary statistics
    st.subheader("ðŸ“‹ Summary Statistics")
    
    stats_col1, stats_col2, stats_col3 = st.columns(3)
    
    with stats_col1:
        st.metric("Total Vehicles", len(df_live))
        st.metric("Moving Vehicles", len(df_live[df_live['speed'] > 0]))
    
    with stats_col2:
        st.metric("Max Speed", f"{df_live['speed'].max():.2f} m/s")
        st.metric("Min Speed", f"{df_live['speed'].min():.2f} m/s")
    
    with stats_col3:
        st.metric("Avg Speed", f"{df_live['speed'].mean():.2f} m/s")
        st.metric("Median Speed", f"{df_live['speed'].median():.2f} m/s")
